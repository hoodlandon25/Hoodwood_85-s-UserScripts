// ==UserScript==
// @name         Universal Key Remapper GUI (Activation Hotkey)
// @namespace    http://tampermonkey.net/
// @version      1.3
// @description  Key remapper GUI activates only after Shift+Ctrl+Alt+I. Temporary session. by Lando Hood / Hoodwood_85
// @author       Lando Hood / Hoodwood_85
// @match        *://*/*
// @grant        none
// ==/UserScript==

(() => {
'use strict';

let activated = false;

document.addEventListener('keydown', function activationListener(e) {
    if (activated) return;
    if (e.shiftKey && e.ctrlKey && e.altKey && normalizeKey(e.key) === 'i') {
        activated = true;
        document.removeEventListener('keydown', activationListener);
        initRemapper();
    }
});

function normalizeKey(key) {
    return key.length === 1 ? key.toLowerCase() : key;
}

function initRemapper() {

const config = { panelWidth: 260, zIndex: 999999 };
const remap = new Map();
const activeRemaps = new Map();
const syntheticFlag = Symbol('syntheticKey');

let startupNoticeVisible = true;

function updateCounter() {
    const uniquePairs = new Set();
    for (let [a, b] of remap.entries()) {
        const pair = [a, b].sort().join(':');
        uniquePairs.add(pair);
    }
    counter.textContent = `Remaps: ${uniquePairs.size}`;
}

function clearAll() {
    remap.clear();
    activeRemaps.clear();
    updateCounter();
}

function createSyntheticEvent(type, originalEvent, newKey) {
    const event = new KeyboardEvent(type, {
        key: newKey,
        code: newKey.length === 1 ? `Key${newKey.toUpperCase()}` : originalEvent.code,
        location: originalEvent.location,
        ctrlKey: originalEvent.ctrlKey,
        shiftKey: originalEvent.shiftKey,
        altKey: originalEvent.altKey,
        metaKey: originalEvent.metaKey,
        repeat: originalEvent.repeat,
        bubbles: true,
        cancelable: true
    });
    Object.defineProperty(event, syntheticFlag, { value: true });
    return event;
}

function handleKeyEvent(e) {
    if (e[syntheticFlag]) return;

    if (startupNoticeVisible) removeStartupNotice();

    const key = normalizeKey(e.key);
    if (!remap.has(key)) return;

    const mappedKey = remap.get(key);
    e.preventDefault();
    e.stopPropagation();

    if (e.type === 'keydown') {
        if (!activeRemaps.has(key)) {
            activeRemaps.set(key, mappedKey);
            const syntheticDown = createSyntheticEvent('keydown', e, mappedKey);
            e.target.dispatchEvent(syntheticDown);
        }
    }

    if (e.type === 'keyup') {
        if (activeRemaps.has(key)) {
            const syntheticUp = createSyntheticEvent('keyup', e, mappedKey);
            e.target.dispatchEvent(syntheticUp);
            activeRemaps.delete(key);
        }
    }
}

document.addEventListener('keydown', handleKeyEvent, true);
document.addEventListener('keyup', handleKeyEvent, true);

const panel = document.createElement('div');
panel.style.position = 'fixed';
panel.style.top = '20px';
panel.style.right = '20px';
panel.style.width = config.panelWidth + 'px';
panel.style.background = '#1e1e1e';
panel.style.color = '#fff';
panel.style.padding = '10px';
panel.style.borderRadius = '8px';
panel.style.fontSize = '14px';
panel.style.fontFamily = 'Arial, sans-serif';
panel.style.zIndex = config.zIndex;
panel.style.boxShadow = '0 4px 12px rgba(0,0,0,0.4)';
panel.style.userSelect = 'none';

const title = document.createElement('div');
title.textContent = 'Key Remapper';
title.style.fontWeight = 'bold';
title.style.marginBottom = '8px';
title.style.cursor = 'move';

const counter = document.createElement('div');
counter.textContent = 'Remaps: 0';
counter.style.marginBottom = '8px';

const addBtn = document.createElement('button');
addBtn.textContent = '+';
addBtn.style.width = '40px';
addBtn.style.marginRight = '5px';

const clearBtn = document.createElement('button');
clearBtn.textContent = 'Clear';
clearBtn.style.flex = '1';

const btnRow = document.createElement('div');
btnRow.style.display = 'flex';
btnRow.appendChild(addBtn);
btnRow.appendChild(clearBtn);

panel.appendChild(title);
panel.appendChild(counter);
panel.appendChild(btnRow);
document.body.appendChild(panel);

let isDragging = false;
let offsetX, offsetY;

title.addEventListener('mousedown', (e) => {
    isDragging = true;
    offsetX = e.clientX - panel.offsetLeft;
    offsetY = e.clientY - panel.offsetTop;
});

document.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    panel.style.left = (e.clientX - offsetX) + 'px';
    panel.style.top = (e.clientY - offsetY) + 'px';
    panel.style.right = 'auto';
});

document.addEventListener('mouseup', () => { isDragging = false; });

function openModal() {
    const overlay = document.createElement('div');
    overlay.style.position = 'fixed';
    overlay.style.inset = '0';
    overlay.style.background = 'rgba(0,0,0,0.5)';
    overlay.style.display = 'flex';
    overlay.style.alignItems = 'center';
    overlay.style.justifyContent = 'center';
    overlay.style.zIndex = config.zIndex + 1;

    const modal = document.createElement('div');
    modal.style.background = '#2a2a2a';
    modal.style.padding = '20px';
    modal.style.borderRadius = '8px';
    modal.style.display = 'flex';
    modal.style.alignItems = 'center';
    modal.style.gap = '8px';

    const inputA = document.createElement('input');
    const inputB = document.createElement('input');
    const confirmBtn = document.createElement('button');

    inputA.placeholder = 'Key';
    inputB.placeholder = 'Key';
    confirmBtn.textContent = 'OK';
    inputA.style.width = '60px';
    inputB.style.width = '60px';

    function captureKey(input) {
        input.addEventListener('keydown', (e) => {
            e.preventDefault();
            input.value = normalizeKey(e.key);
        });
    }
    captureKey(inputA);
    captureKey(inputB);

    confirmBtn.addEventListener('click', () => {
        const keyA = normalizeKey(inputA.value.trim());
        const keyB = normalizeKey(inputB.value.trim());
        if (!keyA || !keyB) return;
        remap.set(keyA, keyB);
        remap.set(keyB, keyA);
        updateCounter();
        document.body.removeChild(overlay);
    });

    modal.appendChild(inputA);
    modal.appendChild(document.createTextNode('to'));
    modal.appendChild(inputB);
    modal.appendChild(confirmBtn);
    overlay.appendChild(modal);
    document.body.appendChild(overlay);
}

addBtn.addEventListener('click', openModal);
clearBtn.addEventListener('click', clearAll);

const startupNotice = document.createElement('div');
startupNotice.style.position = 'fixed';
startupNotice.style.inset = '0';
startupNotice.style.background = 'rgba(0,0,0,0.85)';
startupNotice.style.display = 'flex';
startupNotice.style.alignItems = 'center';
startupNotice.style.justifyContent = 'center';
startupNotice.style.color = '#fff';
startupNotice.style.fontSize = '22px';
startupNotice.style.fontFamily = 'Arial, sans-serif';
startupNotice.style.zIndex = config.zIndex + 2;
startupNotice.style.transition = 'opacity 0.4s ease';
startupNotice.textContent = 'Universal Key Remapper\nby Lando Hood / Hoodwood_85';
startupNotice.style.whiteSpace = 'pre';

document.body.appendChild(startupNotice);

function removeStartupNotice() {
    if (!startupNoticeVisible) return;
    startupNoticeVisible = false;
    startupNotice.style.opacity = '0';
    setTimeout(() => { if (startupNotice.parentNode) startupNotice.parentNode.removeChild(startupNotice); }, 400);
}

console.log('Universal Key Remapper Activated');
}
})();
